# BOBI PDF Processing Integration: Migration from Flask Service to Django

## Current Architecture (What We Have Now)
```
Django Admin (Flashcard model)
    ↓
    └─ POST /api/process to Flask BOBI Service (port 5000)
         └─ Returns JSON + Base64 images
    ↓
Django stores images in FlashcardImage table
```

**Problems:**
- Requires running 2 separate services (Django + Flask)
- Network communication overhead (HTTP requests between Django and Flask)
- Deployment complexity (manage 2 services)
- Latency issues if Flask service is down or on different server

---

## Proposed New Architecture (Integrated Into Django)
```
Django Admin (Flashcard model)
    ↓
    └─ Flashcard.save() calls _process_pdf_with_bobi()
         └─ All PDF processing happens WITHIN Django:
            1. PDF received from upload form
            2. Open PDF with PyMUPDF (fitz)
            3. Extract each page
            4. Convert page to image (PNG/JPEG)
            5. Apply watermark overlay
            6. Save image to media folder
            7. Create FlashcardImage records in DB
    ↓
Images stored in media/flashcards/ folder
```

**Advantages:**
- Single Django service (simpler deployment)
- No network calls (faster processing)
- Direct database transactions
- Atomic operations (all-or-nothing)
- Can use Django's transaction management
- No Flask service to maintain/monitor

---

## Code Migration Plan

### Files to Remove/Delete
- ❌ `bobi/app.py` (entire Flask app) — DELETE
- ❌ `bobi/watermark.py` (will move to Django) — DELETE
- ❌ `bobi/requirements.txt` (Flask dependencies) — DELETE
- ❌ `bobi/` folder (entire folder) — DELETE
- ❌ `notes/utils.py` (BOBI API client) — DELETE

### Files to Create/Modify

#### 1. `notes/pdf_processing.py` (NEW)
**Purpose:** Core PDF processing module (moved from bobi/)
**Contents:**
- `apply_watermark_to_image()` — Image watermarking function
- `process_pdf_to_images()` — Main processor:
  - Open PDF with PyMUPDF
  - Loop through pages
  - Convert each page to image
  - Apply watermark
  - Encode to PIL Image objects
  - Return list of (image_pil, page_num) tuples

#### 2. `notes/models.py` (MODIFY)
**Changes:**
- Update `_process_pdf_with_bobi()` method:
  - Remove HTTP request to Flask
  - Call `pdf_processing.process_pdf_to_images()` directly
  - Loop through returned images
  - Create FlashcardImage records
  - Use `transaction.atomic()` for all-or-nothing semantics

#### 3. `project/settings.py` (MODIFY)
**Changes:**
- Remove BOBI_SERVICE_URL settings (no longer needed)
- Remove BOBI_REQUEST_TIMEOUT
- Keep BOBI_DPI and BOBI_FORMAT (for image conversion settings)
- Add PDF_PROCESSING_TIMEOUT (for local processing) ( GIVE MAXIMUM TIME..okay NO timeout...okay ..KEEP ON PROCESSING UNTIL THE pdf is completed with logo and images and inserted to models)
- Add WATERMARK_OPACITY, WATERMARK_ANGLE settings

#### 4. `notes/admin.py` (KEEP)
**No changes needed**
- Modal will still show during processing
- Processing happens in `Flashcard.save()` (synchronously or async)

---

## Dependencies Changes

### Remove from requirements.txt
- ❌ Flask
- ❌ Werkzeug
- ❌ Jinja2

### Keep/Add to requirements.txt
- ✓ PyMUPDF (fitz) — PDF rendering
- ✓ Pillow (PIL) — Image manipulation
- ✓ CairoSVG — SVG to PNG rendering
- ✓ ReportLab — Watermark drawing (optional)
- ✓ Django 5.2+

### Optional: For Async Processing
- Celery (task queue) — if processing should be async
- Redis (message broker) — for Celery
- OR: Use Django async views with `async_to_sync()`

---

## Settings Configuration

```python
# settings.py

# PDF Processing Settings
BOBI_DPI = 200                          # PDF to image resolution
BOBI_FORMAT = 'png'                     # Output format (png/jpeg)
PDF_PROCESSING_TIMEOUT = 300            # Max seconds for processing
WATERMARK_OPACITY = 0.5                 # Watermark transparency (0-1)
WATERMARK_ANGLE = 0                     # Rotation angle in degrees
WATERMARK_SCALE = 0.25                  # Size as fraction of image
WATERMARK_SPACING = (320, 380)          # (horizontal, vertical) grid spacing
WATERMARK_SVG_PATH = BASE_DIR / 'logo.svg'  # Path to watermark SVG
```
PLESE copy the logo.svg to the rot project directory and mention it where the logo is needed
---

## Processing Flow (Synchronous vs Async)

### Option A: Synchronous (Current Modal Approach - RECOMMENDED FOR NOW)
```
User uploads PDF in Django admin → Click Save
    ↓
Flashcard.save() triggers
    ↓
_process_pdf_with_bobi() runs IMMEDIATELY (blocks request)
    ↓
PDF processing happens in Django thread
    ↓
FlashcardImage records created
    ↓
Response sent to browser
    ↓
Page reloads, modal disappears
    ↓
Images visible in inline preview
```

**Pros:** Simple, atomic transactions, modal shows real progress
**Cons:** Long processing blocks the admin request (timeout risk for huge PDFs)

### Option B: Asynchronous (Future Enhancement)
```
User uploads PDF → Click Save
    ↓
Flashcard.save() creates Flashcard record ONLY
    ↓
Celery task queued for PDF processing
    ↓
Response sent immediately
    ↓
Modal shows "Processing in background..."
    ↓
Celery worker processes PDF asynchronously
    ↓
Modal polls status endpoint
    ↓
When done, modal disappears, page refreshes
```

**Pros:** Non-blocking, scales to huge PDFs
**Cons:** More complex (Celery + Redis), eventual consistency

**Decision:** Use **Option A (Synchronous)** for now. Add Celery later if needed.
YES USE OPTION A ONLY FOR NOW ...
---

## Error Handling Strategy

### In `pdf_processing.py`:
```python
def process_pdf_to_images(pdf_path, dpi=200, format='png'):
    """
    Raises:
    - FileNotFoundError: PDF file doesn't exist
    - ValueError: Invalid PDF or no pages
    - IOError: Cannot write to output directory
    - Exception: PDF processing error (watermark, encoding, etc.)
    """
```

### In `Flashcard._process_pdf_with_bobi()`:
```python
try:
    images = process_pdf_to_images(pdf_path, ...)
    
    with transaction.atomic():
        for img, page_num in images:
            FlashcardImage.objects.create(...)
            
except FileNotFoundError:
    raise ValidationError("PDF file not found")
except ValueError as e:
    raise ValidationError(f"Invalid PDF: {str(e)}")
except Exception as e:
    logger.exception(f"PDF processing failed: {e}")
    raise ValidationError(f"Processing error: {str(e)}")
```

---

## Implementation Order

### Phase 1: Code Migration (Today)
1. Create `notes/pdf_processing.py` with all processing logic
2. Update `notes/models.py` to use `pdf_processing` module
3. Delete `bobi/` folder and remove Flask code
4. Update Django `settings.py` with new configuration

### Phase 2: Testing (After Phase 1)
1. Test PDF upload in Django admin
2. Verify images are created correctly
3. Check watermark appearance
4. Verify modal still shows during processing
5. Test error cases (invalid PDF, missing file, etc.)

### Phase 3: Optional Optimization (Future)
1. Add Celery for async processing (if needed)
2. Add progress tracking endpoint (for long-running processes)
3. Add admin action to reprocess PDFs

---

## File Structure After Migration

```
edvoyage-notes-only-backend-demo-delete-soon/
├── bobi/                    ❌ DELETED
├── notes/
│   ├── admin.py             (KEEP - no changes)
│   ├── models.py            (MODIFY - remove HTTP calls)
│   ├── pdf_processing.py    (NEW - process PDF locally)
│   ├── utils.py             ❌ DELETE (no longer needed)
│   ├── pdf_watermark.py     ❌ DELETE (move to pdf_processing.py)
│   ├── templates/
│   │   └── admin/notes/flashcard/change_form.html  (KEEP - modal works same)
│   └── static/
│       └── admin/css,js/flashcard_modal.css,js     (KEEP)
├── project/
│   └── settings.py          (MODIFY - update PDF settings)
├── db.sqlite3               (KEEP)
├── manage.py                (KEEP)
└── requirements.txt         (MODIFY - remove Flask, keep PDF libs)
```

---

## Summary of Changes

| Component | Action | Reason |
|-----------|--------|--------|
| Flask BOBI service | Delete | Move to Django |
| bobi/ folder | Delete | Not needed |
| notes/utils.py | Delete | HTTP client not needed |
| notes/pdf_processing.py | Create | Local PDF processing |
| notes/models.py | Modify | Use local processing |
| Django settings.py | Modify | Add PDF settings |
| Modal (admin) | Keep | Still shows progress |
| requirements.txt | Modify | Remove Flask, keep PDF libs |

---

## Expected Behavior After Migration

**Before (Flask-based):**
1. Upload PDF → Click Save
2. Django sends HTTP POST to Flask on port 5000
3. Flask processes PDF, returns JSON+Base64
4. Django decodes and creates images
5. 5-10 second processing time

**After (Django-integrated):**
1. Upload PDF → Click Save
2. Django processes PDF directly (no network call)
3. Images created and saved to disk
4. Database records created atomically
5. 3-7 second processing time (faster, no HTTP overhead)

---

## Rollback Plan (If Issues Arise)
- Keep Git history
- Flask code still available in git (can restore if needed)
- No data loss (images stored same way)
- Easy to revert: restore `bobi/` folder and `notes/utils.py`

---

## Questions Before Implementation?

1. **Async vs Sync?** → Recommend Sync for now
2. **Watermark settings?** → Use current values (opacity=0.5, angle=0, spacing=(320, 380))
3. **PDF timeout?** → Set to 300 seconds (5 minutes) for large files
4. **Test data?** → Can use existing PDFs in database

---

**READY TO CODE?** All planning complete. Next: Implement Phase 1 (code migration).
